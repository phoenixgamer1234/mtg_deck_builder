<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MTG Dual Deck Builder — Full</title>

<style>
:root{--accent:#287271;--muted:#666}
body{font-family:Inter,Segoe UI,Arial,sans-serif;margin:14px;background:#f6f7f8;color:#111}
h1{font-size:20px;margin:0}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
input[type="search"],select{padding:6px 10px;border:1px solid #ccc;border-radius:8px}
button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
button.alt{background:#444}
.layout{display:flex;gap:16px;align-items:flex-start}
.col{background:#fff;border:1px solid #e2e4e6;padding:12px;border-radius:10px;flex:1;min-width:300px}
#results{max-height:50vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-top:6px}
.result{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff}
.deck-list{max-height:30vh;overflow:auto;margin-top:6px;border:1px solid #ddd;border-radius:6px;padding:6px;background:#fdfdfd}
.deck-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px;border-radius:6px;border-bottom:1px dashed #eee}
.count{background:#eee;padding:4px 6px;border-radius:6px;font-weight:700}
.preview{margin-top:12px;text-align:center}
img#previewImg{max-width:100%;border-radius:8px;display:block;margin:0 auto}
.muted{color:var(--muted);font-size:13px}
textarea{width:100%;height:80px;border:1px solid #ddd;border-radius:8px;padding:8px;margin-top:6px;resize:none}
.filter-panel{border-top:1px solid #eee;padding-top:6px;margin-top:6px}
.filter-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
label.checkbox{display:flex;gap:4px;align-items:center}
</style>
</head>

<body>
<header>
<h1>MTG Dual Deck Builder — Full</h1>
<div class="muted">Manage Standard and Commander decks with full advanced filters and Scryfall search.</div>
</header>

<!-- Controls -->
<div class="controls">
<label>Format:
<select id="formatSelect">
<option value="standard">Standard</option>
<option value="commander">Commander</option>
</select>
</label>

<input id="q" type="search" placeholder="Search card name" />
<button id="searchBtn">Search</button>
<button id="toggleFilters" class="alt">Advanced Filters</button>
</div>

<div class="layout">

<!-- LEFT SIDE -->
<main class="col">
<strong>Search Results</strong>
<div id="results"><div class="muted">Search to see cards.</div></div>

<!-- FILTER PANEL -->
<div id="filterPanel" class="filter-panel" style="display:none">

<div class="filter-row">
<label>Type:
<select id="typeSelect">
<option value="">Any</option>
<option>Creature</option><option>Artifact</option><option>Enchantment</option>
<option>Instant</option><option>Sorcery</option><option>Land</option>
<option>Planeswalker</option><option>Tribal</option>
</select></label>

<label>Supertypes:
<select id="supertypeSelect">
<option value="">Any</option>
<option>Legendary</option><option>Basic</option><option>Snow</option>
</select></label>

<label>Subtype:
<input id="subtypeInput" type="text" placeholder="e.g. Elf" />
</label>
</div>

<div class="filter-row">
<label>Colors:
<select id="colorSelect" multiple size="5">
<option value="W">White</option>
<option value="U">Blue</option>
<option value="B">Black</option>
<option value="R">Red</option>
<option value="G">Green</option>
</select></label>

<label>Format Legality:
<select id="formatLegalitySelect">
<option value="">Any</option>
<option value="standard">Standard</option>
<option value="commander">Commander</option>
</select></label>
</div>

<button id="applyFilters" class="alt">Apply Filters</button>
<button id="clearFilters">Clear Filters</button>
</div>
</main>

<!-- RIGHT SIDE -->
<aside class="col">
<strong id="deckTitle">Your Deck (Standard)</strong>
<div class="deck-list" id="deckArea"></div>

<strong>Import / Export (Untap Format)</strong>
<textarea id="importExportArea" placeholder="Deck list appears here"></textarea>

<div style="display:flex;gap:6px;margin-top:4px">
<button id="importDeckBtn">Apply Import</button>
<button id="exportDeckBtn">Update Export</button>
</div>

<div class="preview">
<strong id="previewTitle">Preview</strong>
<div class="muted" id="previewType"></div>
<img id="previewImg" style="display:none" />
<div id="previewPlaceholder" class="muted">No card selected</div>
</div>
</aside>

</div>

<script>
/* ---------- DECK STATE ---------- */
const decks = {
  standard: { map:{}, order:[] },
  commander:{ map:{}, order:[], commander:null }
};

let activeFormat="standard";
let lastSearchData=[];
const resultsDiv = document.getElementById("results");

/* ---------- HELPERS ---------- */
function getDeck(){ return decks[activeFormat]; }

function updateDeckTitle(){
  document.getElementById("deckTitle").textContent =
    "Your Deck ("+activeFormat.charAt(0).toUpperCase()+activeFormat.slice(1)+")";
}

function renderDeck(){
  const deck = getDeck();
  const area = document.getElementById("deckArea");
  area.innerHTML = "";

  deck.order.forEach(id=>{
    const e = deck.map[id];

    const row = document.createElement("div");
    row.className="deck-row";

    const left = document.createElement("div");
    left.innerHTML = `<strong>${e.card.name}</strong> <span class="muted">${e.card.type_line||""}</span>`;

    const right = document.createElement("div");
    right.style.display="flex"; right.style.gap="6px";

    const count = document.createElement("div");
    count.className="count"; count.textContent=e.count;

    const plus=document.createElement("button"); plus.textContent="+";
    plus.onclick=()=>addToDeck(e.card);

    const minus=document.createElement("button"); minus.textContent="−";
    minus.onclick=()=>removeOne(id);

    const remove=document.createElement("button"); remove.textContent="Remove";
    remove.onclick=()=>removeAll(id);

    right.append(count,plus,minus,remove);
    row.append(left,right);
    area.appendChild(row);
  });

  updateExport();
}

/* ---------- ADD / REMOVE ---------- */
function addToDeck(card){
  const deck=getDeck();
  const id = card.id;

  const count = deck.map[id]?.count || 0;

  if(activeFormat==="standard" && count>=4){
    alert("Standard: max 4 copies.");
    return;
  }

  if(activeFormat==="commander" && count>=1){
    alert("Commander: 1 copy max.");
    return;
  }

  if(!deck.map[id]){
    deck.map[id]={card,count:0};
    deck.order.push(id);
  }

  deck.map[id].count++;
  renderDeck();
}

function removeOne(id){
  const deck=getDeck();
  if(!deck.map[id]) return;

  deck.map[id].count--;
  if(deck.map[id].count<=0){
    delete deck.map[id];
    deck.order = deck.order.filter(x=>x!==id);
  }
  renderDeck();
}

function removeAll(id){
  const deck=getDeck();
  if(deck.map[id]){
    delete deck.map[id];
    deck.order = deck.order.filter(x=>x!==id);
  }
  renderDeck();
}

/* ---------- PREVIEW ---------- */
async function previewCard(id){
  const res=await fetch("https://api.scryfall.com/cards/"+id);
  const card=await res.json();

  let img = card.image_uris?.normal ||
            card.card_faces?.[0]?.image_uris?.normal;

  const imgEl=document.getElementById("previewImg");
  const ph=document.getElementById("previewPlaceholder");

  if(img){
    imgEl.src=img;
    imgEl.style.display="block";
    ph.style.display="none";
  } else {
    imgEl.style.display="none";
    ph.style.display="block";
  }

  document.getElementById("previewTitle").textContent = card.name;
  document.getElementById("previewType").textContent = card.type_line||"";
}

/* ---------- FILTERS ---------- */
function gatherFilters(){
  return {
    type: document.getElementById("typeSelect").value,
    supertype: document.getElementById("supertypeSelect").value,
    subtype: document.getElementById("subtypeInput").value.trim(),
    colors: Array.from(document.getElementById("colorSelect").selectedOptions).map(o=>o.value),
    legality: document.getElementById("formatLegalitySelect").value
  };
}

function matches(card,f){
  if(f.supertype && !card.type_line?.toLowerCase().includes(f.supertype.toLowerCase())) return false;
  if(f.type && !card.type_line?.toLowerCase().includes(f.type.toLowerCase())) return false;

  if(f.subtype){
    let parts=(card.type_line||"").split("—");
    if(!parts[1] || !parts[1].toLowerCase().includes(f.subtype.toLowerCase())) return false;
  }

  if(f.colors.length>0){
    let c = card.color_identity || [];
    if(!f.colors.every(x=>c.includes(x))) return false;
  }

  if(f.legality){
    if(!card.legalities || card.legalities[f.legality] !== "legal") return false;
  }

  return true;
}

/* ---------- SEARCH ---------- */
async function search(){
  const q = document.getElementById("q").value.trim() || "a";

  resultsDiv.innerHTML = '<div class="muted">Searching…</div>';

  const res = await fetch("https://api.scryfall.com/cards/search?q="+encodeURIComponent(q));
  const data = await res.json();

  if(!data.data){
    resultsDiv.innerHTML = '<div class="muted">No results.</div>';
    return;
  }

  lastSearchData = data.data;
  const filters = gatherFilters();

  const filtered = data.data.filter(c=>matches(c,filters));

  resultsDiv.innerHTML="";
  filtered.forEach(c=>{
    const row=document.createElement("div");
    row.className="result";

    const meta=document.createElement("div");
    meta.innerHTML=`<strong>${c.name}</strong> <span class="muted">${c.type_line||""}</span>`;

    const add=document.createElement("button");
    add.textContent="Add";
    add.onclick=()=>addToDeck(c);

    const prev=document.createElement("button");
    prev.textContent="Preview";
    prev.onclick=()=>previewCard(c.id);

    row.append(meta,add,prev);
    resultsDiv.appendChild(row);
  });
}

/* ---------- IMPORT / EXPORT ---------- */
function updateExport(){
  const deck=getDeck();
  let text="";
  deck.order.forEach(id=>{
    let e=deck.map[id];
    text += `${e.count} ${e.card.name}\n`;
  });
  document.getElementById("importExportArea").value=text.trim();
}

function importDeck(){
  let text=document.getElementById("importExportArea").value.trim();
  if(!text) return;

  const deck=getDeck();
  deck.map={}; deck.order=[];

  text.split("\n").forEach(line=>{
    let m=line.match(/^(\d+)\s+(.*)$/);
    if(!m) return;

    let count=parseInt(m[1]);
    let name=m[2];

    // placeholder card (full details loaded when added manually)
    let fake={ id:"local-"+name, name, type_line:"", image_uris:null };

    deck.map[fake.id]={card:fake,count};
    deck.order.push(fake.id);
  });

  renderDeck();
}

/* ---------- EVENT HANDLERS ---------- */
document.getElementById("searchBtn").onclick=search;
document.getElementById("applyFilters").onclick=search;
document.getElementById("clearFilters").onclick=()=>{
  document.getElementById("typeSelect").value="";
  document.getElementById("supertypeSelect").value="";
  document.getElementById("subtypeInput").value="";
  [...document.getElementById("colorSelect").options].forEach(o=>o.selected=false);
  document.getElementById("formatLegalitySelect").value="";
  search();
};
document.getElementById("toggleFilters").onclick=()=>{
  let p=document.getElementById("filterPanel");
  p.style.display = p.style.display==="none" ? "block" : "none";
};
document.getElementById("formatSelect").onchange=e=>{
  activeFormat=e.target.value;
  updateDeckTitle();
  renderDeck();
};
document.getElementById("exportDeckBtn").onclick=updateExport;
document.getElementById("importDeckBtn").onclick=importDeck;

/* ---------- INIT ---------- */
updateDeckTitle();
renderDeck();
</script>

</body>
</html>
