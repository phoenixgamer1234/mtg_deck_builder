<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MTG Deck Builder — Simple List</title>
<style>
  body{font-family:Arial,sans-serif;margin:14px;background:#f6f7f8;color:#111}
  header{margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
  input[type="search"]{padding:6px 10px;border:1px solid #ccc;border-radius:6px;width:280px}
  button{background:#287271;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer}
  button.alt{background:#444}
  #results{max-height:50vh;overflow:auto;display:flex;flex-direction:column;gap:6px;padding-top:6px}
  .result{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;border:1px solid #eee;background:#fff}
  .meta{flex:1}
  .meta small{display:block;color:#666;margin-top:2px;font-size:12px}
  #deckList{background:#fff;border:1px solid #e2e4e6;padding:8px;border-radius:8px;max-height:40vh;overflow:auto}
  .deck-row{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;border-bottom:1px dashed #eee}
  .deck-row:last-child{border-bottom:none}
  .count{font-weight:700;margin-right:6px}
</style>
</head>
<body>

<header>
  <h1>MTG Deck Builder — Simple List</h1>
</header>

<div class="controls">
  <input id="q" type="search" placeholder="Search card name..." />
  <button id="searchBtn">Search</button>
</div>

<div id="results"><div class="muted">Search to see results</div></div>

<h2>Your Deck</h2>
<div id="deckList"><div class="muted">No cards yet</div></div>

<script>
const SRY_BASE = 'https://api.scryfall.com/cards/search?q=';
const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
let deck = {}; // key = card id, value = {name, type_line, count, image_uri}

// Utils
function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function normalizeCard(card){
  const id = card.id || ('local:' + card.name || 'unknown');
  const name = card.name || 'Unknown';
  const type_line = card.type_line || '';
  let image_uri = '';
  if (card.image_uris && card.image_uris.normal) image_uri = card.image_uris.normal;
  else if (card.card_faces && card.card_faces[0] && card.card_faces[0].image_uris && card.card_faces[0].image_uris.normal)
    image_uri = card.card_faces[0].image_uris.normal;
  return {id,name,type_line,image_uri};
}

// Deck rendering
function renderDeck(){
  const deckDiv = document.getElementById('deckList');
  deckDiv.innerHTML = '';
  const keys = Object.keys(deck);
  if (!keys.length){ deckDiv.innerHTML = '<div class="muted">No cards yet</div>'; return; }
  keys.forEach(id=>{
    const c = deck[id];
    const row = document.createElement('div'); row.className='deck-row';
    const left = document.createElement('div'); left.innerHTML = `<span class="count">${c.count}</span> ${escapeHtml(c.name)} <small>${escapeHtml(c.type_line)}</small>`;
    const right = document.createElement('div');
    const plus = document.createElement('button'); plus.textContent='+'; plus.onclick=()=>{c.count++; renderDeck();};
    const minus = document.createElement('button'); minus.textContent='−'; minus.onclick=()=>{
      c.count--; if(c.count<=0) delete deck[id]; renderDeck();
    };
    right.appendChild(plus); right.appendChild(minus);
    row.appendChild(left); row.appendChild(right);
    deckDiv.appendChild(row);
  });
}

// Fetch helper
async function fetchJsonWithFallback(url){
  try{
    const r = await fetch(url); if(!r.ok) throw new Error('Direct fetch failed');
    return await r.json();
  }catch(err){
    const prox = CORS_PROXY + encodeURIComponent(url);
    const r2 = await fetch(prox);
    if(!r2.ok) throw new Error('Proxy fetch failed');
    return await r2.json();
  }
}

// Search
async function doSearch(q){
  const query = q && q.trim().length ? q.trim() : 'a';
  const url = SRY_BASE + encodeURIComponent(query);
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '<div class="muted">Searching...</div>';
  try{
    const data = await fetchJsonWithFallback(url);
    const entries = data.data || [];
    if(!entries.length){ resultsDiv.innerHTML='<div class="muted">No results</div>'; return; }
    resultsDiv.innerHTML='';
    entries.slice(0,50).forEach(raw=>{
      const c = normalizeCard(raw);
      const row = document.createElement('div'); row.className='result';
      const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML=`<strong>${escapeHtml(c.name)}</strong><small>${escapeHtml(c.type_line)}</small>`;
      const btn = document.createElement('button'); btn.textContent='Add'; btn.onclick=()=>{ 
        if(!deck[c.id]) deck[c.id] = {...c,count:1}; else deck[c.id].count++; renderDeck();
      };
      row.appendChild(meta); row.appendChild(btn);
      resultsDiv.appendChild(row);
    });
  }catch(e){ resultsDiv.innerHTML='<div class="muted">Search failed</div>'; console.error(e);}
}

// Events
document.getElementById('searchBtn').addEventListener('click',()=>{doSearch(document.getElementById('q').value.trim());});
document.getElementById('q').addEventListener('keydown',e=>{if(e.key==='Enter') doSearch(document.getElementById('q').value.trim());});

</script>
</body>
</html>
