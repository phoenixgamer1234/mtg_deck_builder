<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MTG Deck Builder — Untap List with Live List</title>
<style>
body{font-family:Inter,Segoe UI,Arial,sans-serif;margin:14px;background:#f6f7f8;color:#111}
header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
h1{font-size:20px;margin:0}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
input[type="search"]{padding:8px 10px;border:1px solid #ccc;border-radius:8px;width:320px}
button{background:#287271;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
button.alt{background:#444}
.layout{display:flex;gap:16px;align-items:flex-start}
.col{background:#fff;border:1px solid #e2e4e6;padding:12px;border-radius:10px}
.left{flex:1;min-width:360px}
.right{width:380px}
#results{max-height:50vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-top:6px}
.result{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff}
.thumb{width:48px;height:70px;background:#f2f3f4;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#999}
.meta{flex:1}
.meta small{display:block;color:#666;margin-top:4px}
.deck-list{max-height:30vh;overflow:auto;margin-top:6px}
.deck-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:6px;border-bottom:1px dashed #eee}
.count{background:#eee;padding:6px 8px;border-radius:6px;font-weight:700}
.preview{margin-top:12px;text-align:center}
.muted{color:#666;font-size:13px}
textarea{width:100%;height:120px;border:1px solid #ddd;border-radius:8px;padding:8px;margin-top:6px}
.row{display:flex;gap:8px;align-items:center}
.filters{margin-top:10px;border-top:1px solid #eee;padding-top:10px}
.filter-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
select, input[type="text"]{padding:6px;border-radius:6px;border:1px solid #ccc}
label.checkbox{display:flex;gap:6px;align-items:center}
.small{font-size:13px;color:#444}
</style>
</head>
<body>
<header>
  <div>
    <h1>MTG Deck Builder — Untap List</h1>
    <div class="muted">Advanced Filters and live plain list below your deck.</div>
  </div>
</header>

<div class="controls">
  <input id="q" type="search" placeholder="Name / keyword (press Enter or Search)" />
  <button id="searchBtn">Search</button>
  <button id="toggleFilters" class="alt">Show Advanced Filters</button>
</div>

<div class="layout">
<main class="col left">
  <div><strong>Search results</strong> <span id="searchInfo" class="muted"></span></div>
  <div id="filterPanel" class="filters" style="display:none">
    <div class="filter-row">
      <div style="min-width:220px">
        <label class="small">Supertype</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <label class="checkbox"><input type="checkbox" value="Legendary" class="suptype" /> Legendary</label>
          <label class="checkbox"><input type="checkbox" value="Basic" class="suptype" /> Basic</label>
          <label class="checkbox"><input type="checkbox" value="Snow" class="suptype" /> Snow</label>
        </div>
      </div>
      <div style="min-width:180px">
        <label class="small">Type</label>
        <select id="typeSelect">
          <option value="">Any</option>
          <option>Creature</option><option>Artifact</option><option>Enchantment</option><option>Instant</option>
          <option>Sorcery</option><option>Land</option><option>Planeswalker</option><option>Tribal</option>
        </select>
      </div>
      <div style="min-width:180px">
        <label class="small">Subtype (text)</label>
        <input id="subtypeInput" type="text" placeholder="e.g. Elf, Zombie" />
      </div>
    </div>
    <div class="filter-row">
      <div>
        <label class="small">Mana Colors (card must include all selected)</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <label class="checkbox"><input type="checkbox" value="W" class="colorChk" /> W</label>
          <label class="checkbox"><input type="checkbox" value="U" class="colorChk" /> U</label>
          <label class="checkbox"><input type="checkbox" value="B" class="colorChk" /> B</label>
          <label class="checkbox"><input type="checkbox" value="R" class="colorChk" /> R</label>
          <label class="checkbox"><input type="checkbox" value="G" class="colorChk" /> G</label>
        </div>
      </div>
      <div style="min-width:220px">
        <label class="small">Format legality</label>
        <select id="formatSelect">
          <option value="">Any</option>
          <option value="standard">Standard</option>
          <option value="pioneer">Pioneer</option>
          <option value="modern">Modern</option>
          <option value="legacy">Legacy</option>
          <option value="vintage">Vintage</option>
          <option value="commander">Commander</option>
          <option value="pauper">Pauper</option>
          <option value="historic">Historic</option>
          <option value="brawl">Brawl</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
      <button id="applyFilters" class="alt">Apply Filters</button>
      <button id="clearFilters">Clear Filters</button>
    </div>
  </div>

  <div id="results" aria-live="polite" style="margin-top:12px">
    <div class="muted">Search to see results.</div>
  </div>
</main>

<aside class="col right">
  <div>
    <strong>Your Deck</strong>
    <div class="muted">Plain Untap-style list below, updates live</div>
    <div id="deckArea" class="deck-list" aria-live="polite"></div>
    <textarea id="deckText" placeholder="Your deck list will appear here..."></textarea>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button id="exportBtn">Export List</button>
      <button id="importBtn" class="alt">Import List</button>
    </div>
  </div>
</aside>
</div>

<script>
let deckMap = {}; 
let lastPage = 1;

// Scryfall fetch
async function fetchCards(query, page=1){
  const url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&page=${page}`;
  const res = await fetch(url);
  return res.json();
}

// Filters
function gatherFilters(){
  const sups = Array.from(document.querySelectorAll('.suptype:checked')).map(i=>i.value);
  const type = document.getElementById('typeSelect').value;
  const subtype = document.getElementById('subtypeInput').value.trim();
  const colors = Array.from(document.querySelectorAll('.colorChk:checked')).map(c=>c.value);
  const format = document.getElementById('formatSelect').value;
  return { supertypes: sups, type, subtype, colors, format };
}

function cardMatchesFilters(card, filters){
  if(filters.supertypes.length){
    const typeLine = card.type_line?.toLowerCase()||'';
    if(!filters.supertypes.every(s=>typeLine.includes(s.toLowerCase()))) return false;
  }
  if(filters.type){
    if(!(card.type_line?.toLowerCase()||'').includes(filters.type.toLowerCase())) return false;
  }
  if(filters.subtype){
    const subs = (card.type_line?.split('—')[1]||'').toLowerCase();
    if(!subs.includes(filters.subtype.toLowerCase())) return false;
  }
  if(filters.colors.length){
    if(!filters.colors.every(c=> (card.colors||[]).includes(c))) return false;
  }
  if(filters.format){
    if(card.legalities?.[filters.format]!=='legal') return false;
  }
  return true;
}

// Render search results
function renderResults(cards){
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';
  if(!cards.length){ resultsDiv.innerHTML='<div class="muted">No results.</div>'; return; }
  cards.slice(0,50).forEach(card=>{
    const row = document.createElement('div'); row.className='result';
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.textContent=(card.set||'').toUpperCase();
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<strong>${card.name}</strong><small>${card.type_line||''}</small>`;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const addBtn=document.createElement('button'); addBtn.textContent='Add';
    addBtn.onclick=()=> addToDeck(card);
    actions.appendChild(addBtn);
    row.appendChild(thumb); row.appendChild(meta); row.appendChild(actions);
    resultsDiv.appendChild(row);
  });
}

// Deck functions
function updateDeckText(){
  const textarea = document.getElementById('deckText');
  textarea.value = Object.values(deckMap).map(d=>`${d.count} ${d.card.name}`).join('\n');
}

function renderDeck(){
  const deckArea=document.getElementById('deckArea'); deckArea.innerHTML='';
  for(const name in deckMap){
    const row=document.createElement('div'); row.className='deck-row';
    row.textContent=`${deckMap[name].count} ${name}`;
    deckArea.appendChild(row);
  }
  updateDeckText();
}

function addToDeck(card){
  const name=card.name;
  if(!deckMap[name]) deckMap[name]={count:0, card};
  deckMap[name].count++;
  renderDeck();
}

// Search flow
async function doSearch(query){
  document.getElementById('results').innerHTML='<div class="muted">Searching…</div>';
  try{
    const data = await fetchCards(query,lastPage);
    const filters = gatherFilters();
    const filtered = (data.data||[]).filter(c=>cardMatchesFilters(c,filters));
    renderResults(filtered);
  }catch(e){ document.getElementById('results').innerHTML='<div class="muted">Error fetching cards.</div>'; console.error(e);}
}

// Events
document.getElementById('searchBtn').onclick = ()=>{ lastPage=1; doSearch(document.getElementById('q').value.trim()||'a'); };
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ lastPage=1; doSearch(document.getElementById('q').value.trim()||'a'); }});
document.getElementById('toggleFilters').onclick = ()=>{
  const panel=document.getElementById('filterPanel');
  panel.style.display = panel.style.display==='none'?'block':'none';
  document.getElementById('toggleFilters').textContent = panel.style.display==='none'?'Show Advanced Filters':'Hide Advanced Filters';
};
document.getElementById('applyFilters').onclick=()=>{ lastPage=1; doSearch(document.getElementById('q').value.trim()||'a'); };
document.getElementById('clearFilters').onclick=()=>{
  document.querySelectorAll('.suptype').forEach(i=>i.checked=false);
  document.getElementById('typeSelect').value='';
  document.getElementById('subtypeInput').value='';
  document.querySelectorAll('.colorChk').forEach(i=>i.checked=false);
  document.getElementById('formatSelect').value='';
};

// Export / Import
document.getElementById('exportBtn').onclick = ()=>{
  const list = document.getElementById('deckText').value;
  const blob = new Blob([list],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='deck.txt'; a.click(); URL.revokeObjectURL(a.href);
};

document.getElementById('importBtn').onclick = ()=>{
  const raw = prompt('Paste plain deck list (e.g., "4 Lightning Bolt")');
  if(!raw) return;
  deckMap={};
  raw.split('\n').forEach(line=>{
    const m=line.trim().match(/^(\d+)\s+(.+)$/);
    if(m){ const count=parseInt(m[1]); const name=m[2]; deckMap[name]={count,count,card:{name}}; }
  });
  renderDeck();
};
</script>
</body>
</html>
