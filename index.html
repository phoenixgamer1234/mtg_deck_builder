<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MTG Dual Deck Builder — Full</title>
<style>
:root{--accent:#287271;--muted:#666}
body{font-family:Inter,Segoe UI,Arial,sans-serif;margin:14px;background:#f6f7f8;color:#111}
h1{font-size:20px;margin:0}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
input[type="search"],select{padding:6px 10px;border:1px solid #ccc;border-radius:8px}
button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
button.alt{background:#444}
.layout{display:flex;gap:16px;align-items:flex-start}
.col{background:#fff;border:1px solid #e2e4e6;padding:12px;border-radius:10px;flex:1;min-width:300px}
#results{max-height:50vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-top:6px}
.result{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff}
.deck-list{max-height:30vh;overflow:auto;margin-top:6px;border:1px solid #ddd;border-radius:6px;padding:6px;background:#fdfdfd}
.deck-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px;border-radius:6px;border-bottom:1px dashed #eee}
.count{background:#eee;padding:4px 6px;border-radius:6px;font-weight:700}
.preview{margin-top:12px;text-align:center}
img#previewImg{max-width:100%;border-radius:8px;display:block;margin:0 auto}
.muted{color:var(--muted);font-size:13px}
textarea{width:100%;height:80px;border:1px solid #ddd;border-radius:8px;padding:8px;margin-top:6px;resize:none}
.filter-panel{border-top:1px solid #eee;padding-top:6px;margin-top:6px}
.filter-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
label.checkbox{display:flex;gap:4px;align-items:center}
</style>
</head>
<body>
<header>
<h1>MTG Dual Deck Builder — Full</h1>
<div class="muted">Manage Standard and Commander decks separately with full advanced filters.</div>
</header>

<div class="controls">
<label>Format:
<select id="formatSelect">
<option value="standard">Standard</option>
<option value="commander">Commander</option>
</select>
</label>
<input id="q" type="search" placeholder="Search card name">
<button id="searchBtn">Search</button>
<button id="toggleFilters" class="alt">Advanced Filters</button>
</div>

<div class="layout">
<main class="col">
<strong>Search Results</strong>
<div id="results"><div class="muted">Search to see cards.</div></div>

<div id="filterPanel" class="filter-panel" style="display:none">
<div class="filter-row">
<label>Type:
<select id="typeSelect">
<option value="">Any</option>
<option>Creature</option><option>Artifact</option><option>Enchantment</option>
<option>Instant</option><option>Sorcery</option><option>Land</option>
<option>Planeswalker</option><option>Tribal</option>
</select>
</label>

<label>Supertypes:
<select id="supertypeSelect">
<option value="">Any</option>
<option>Legendary</option><option>Basic</option><option>Snow</option>
</select>
</label>

<label>Subtype:
<input id="subtypeInput" type="text" placeholder="e.g. Elf">
</label>
</div>

<div class="filter-row">
<label>Colors:
<select id="colorSelect" multiple size="5">
<option value="W">White</option>
<option value="U">Blue</option>
<option value="B">Black</option>
<option value="R">Red</option>
<option value="G">Green</option>
</select>
</label>

<label>Format Legality:
<select id="formatLegalitySelect">
<option value="">Any</option>
<option value="standard">Standard</option>
<option value="commander">Commander</option>
</select>
</label>
</div>

<button id="applyFilters" class="alt">Apply Filters</button>
<button id="clearFilters">Clear Filters</button>
</div>
</main>

<aside class="col">
<strong id="deckTitle">Your Deck (Standard)</strong>

<!-- Commander Slot -->
<div id="commanderSlot" style="display:none; margin-bottom:8px;">
  <strong>Commander Card:</strong>
  <div class="deck-row">
    <div id="commanderInfo" class="muted">No commander selected</div>
    <button id="setCommanderBtn">Set from Search</button>
    <button id="removeCommanderBtn">Remove</button>
  </div>
</div>

<div class="deck-list" id="deckArea"></div>

<strong>Import / Export List</strong>
<textarea id="importExportArea" placeholder="Deck list will appear here or paste here to import"></textarea>
<div style="display:flex;gap:6px;margin-top:4px">
<button id="importDeckBtn">Apply Import</button>
<button id="exportDeckBtn">Update Export</button>
</div>

<div class="preview">
<strong id="previewTitle">Preview</strong>
<div class="muted" id="previewType"></div>
<img id="previewImg" alt="card preview" style="display:none">
<div id="previewPlaceholder" class="muted">No card selected</div>
</div>
</aside>
</div>

<script>
const decks={
standard:{map:{},order:[]},
commander:{map:{},order:[],commander:null}
};
let activeFormat='standard';
let lastSearchData=[];

function getCurrentDeck(){ return decks[activeFormat]; }
function updateDeckTitle(){ 
  document.getElementById('deckTitle').textContent='Your Deck ('+activeFormat.charAt(0).toUpperCase()+activeFormat.slice(1)+')'; 
}
function updateCommanderSlotVisibility(){
  document.getElementById('commanderSlot').style.display=(activeFormat==='commander')?'block':'none';
}

function renderDeck(){
  const deck=getCurrentDeck();
  const area=document.getElementById('deckArea');
  area.innerHTML='';

  // Commander on top
  if(activeFormat==='commander' && deck.commander){
    const c=deck.commander;
    const row=document.createElement('div');
    row.className='deck-row';
    row.innerHTML=`<strong>${c.name}</strong> <span class="muted">${c.type_line||''}</span> <span class="muted">(Commander)</span>`;
    area.appendChild(row);
  }

  deck.order.forEach(id=>{
    const e=deck.map[id];
    const row=document.createElement('div'); row.className='deck-row';
    const left=document.createElement('div');
    left.innerHTML=`<strong>${e.card.name}</strong> <span class="muted">${e.card.type_line||''}</span>`;
    const right=document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
    const count=document.createElement('div'); count.className='count'; count.textContent=e.count;
    const plus=document.createElement('button'); plus.textContent='+'; plus.onclick=()=>addToDeck(e.card);
    const minus=document.createElement('button'); minus.textContent='−'; minus.onclick=()=>removeOne(id);
    const rem=document.createElement('button'); rem.textContent='Remove'; rem.onclick=()=>removeAll(id);
    right.append(count,plus,minus,rem);
    row.append(left,right);
    area.appendChild(row);
  });
  updateExportArea();
}

function addToDeck(card){
  const deck=getCurrentDeck();
  const id=card.id||('local:'+card.name);
  const count=deck.map[id]?.count||0;

  if(activeFormat==='standard' && count>=4){ alert('Standard max 4 copies per card'); return; }
  if(activeFormat==='commander'){
    if(deck.commander && id===deck.commander.id){ alert('Commander is already set'); return; }
    if(deck.map[id] && count>=1){ alert('Commander: only 1 copy per card'); return; }
  }
  if(!deck.map[id]) deck.order.push(id), deck.map[id]={card:{id:id,name:card.name,type_line:card.type_line||'',image_uris:card.image_uris||null},count:0};
  deck.map[id].count=(deck.map[id].count||0)+1;
  renderDeck();
}

function removeOne(id){
  const deck=getCurrentDeck();
  if(!deck.map[id]) return;
  deck.map[id].count--;
  if(deck.map[id].count<=0){ delete deck.map[id]; deck.order=deck.order.filter(x=>x!==id); }
  renderDeck();
}

function removeAll(id){
  const deck=getCurrentDeck();
  if(deck.map[id]){ delete deck.map[id]; deck.order=deck.order.filter(x=>x!==id); renderDeck(); }
}

// Preview
async function loadAndPreview(id){
  try{
    const res=await fetch('https://api.scryfall.com/cards/'+encodeURIComponent(id));
    const card=await res.json();
    let img='';
    if(card.image_uris?.normal) img=card.image_uris.normal;
    else if(card.card_faces?.[0]?.image_uris?.normal) img=card.card_faces[0].image_uris.normal;
    const imgEl=document.getElementById('previewImg');
    const ph=document.getElementById('previewPlaceholder');
    if(img){ imgEl.src=img; imgEl.style.display='block'; ph.style.display='none'; }
    else{ imgEl.style.display='none'; ph.style.display='block'; ph.textContent='No image available'; }
    document.getElementById('previewTitle').textContent=card.name;
    document.getElementById('previewType').textContent=card.type_line||'';
  }catch(e){ alert('Preview failed: '+e.message); }
}

// Filters
function gatherFilters(){
  const type=document.getElementById('typeSelect').value||'';
  const supertype=document.getElementById('supertypeSelect').value||'';
  const subtype=document.getElementById('subtypeInput').value.trim()||'';
  const colors=Array.from(document.getElementById('colorSelect').selectedOptions).map(o=>o.value);
  const legality=document.getElementById('formatLegalitySelect').value||'';
  return {type,supertype,subtype,colors,legality};
}

function cardMatchesFilters(card,filters){
  if(filters.supertype && !(card.type_line||'').toLowerCase().includes(filters.supertype.toLowerCase())) return false;
  if(filters.type && !(card.type_line||'').toLowerCase().includes(filters.type.toLowerCase())) return false;
  if(filters.subtype){
    const parts=(card.type_line||'').split('—');
    if(!parts[1] || !parts[1].toLowerCase().includes(filters.subtype.toLowerCase())) return false;
  }
  if(filters.colors.length>0){
    const c=card.colors||[];
    if(!filters.colors.every(ch=>c.includes(ch))) return false;
  }
  if(filters.legality){
    if(!card.legalities || card.legalities[filters.legality]!=='legal') return false;
  }
  return true;
}

// Search
async function doSearch(){
  const query=document.getElementById('q').value.trim()||'a';
  const resultsDiv=document.getElementById('results');
  resultsDiv.innerHTML='<div class="muted">Searching…</div>';
  try{
    const res=await fetch('https://api.scryfall.com/cards/search?q='+encodeURIComponent(query));
    const data=await res.json();
    if(!data.data){ resultsDiv.innerHTML='<div class="muted">No results</div>'; return; }
    lastSearchData=data.data;
    const filters=gatherFilters();
    const filtered=data.data.filter(c=>cardMatchesFilters(c,filters));
    resultsDiv.innerHTML='';
    filtered.forEach(c=>{
      const row=document.createElement('div'); row.className='result';
      const meta=document.createElement('div'); meta.innerHTML=`<strong>${c.name}</strong> <span class="muted">${c.type_line||''}</span>`;
      const addBtn=document.createElement('button'); addBtn.textContent='Add'; addBtn.onclick=()=>addToDeck(c);
      const prevBtn=document.createElement('button'); prevBtn.textContent='Preview'; prevBtn.onclick=()=>loadAndPreview(c.id);
      row.append(meta,addBtn,prevBtn);
      resultsDiv.appendChild(row);
    });
  }catch(e){ resultsDiv.innerHTML='<div class="muted">Search failed</div>'; console.error(e); }
}

// Export/Import text
function updateExportArea(){
  const deck=getCurrentDeck();
  let txt='';
  if(activeFormat==='commander' && deck.commander) txt+=`1 ${deck.commander.name}\n`;
  deck.order.forEach(id=>{ const e=deck.map[id]; txt+=`${e.count} ${e.card.name}\n`; });
  document.getElementById('importExportArea').value=txt.trim();
}

// Import
document.getElementById('importDeckBtn').addEventListener('click',()=>{
  const text=document.getElementById('importExportArea').value;
  if(!text) return;
  const lines=text.split('\n').map(l=>l.trim()).filter(l=>l);
  const deck=getCurrentDeck();
  deck.map={}; deck.order=[]; deck.commander=null;
  lines.forEach(line=>{
    const m=line.match(/^(\d+)\s+(.*)$/);
    if(m){
      const count=parseInt(m[1]); const name=m[2]; const id='local:'+name;
      if(activeFormat==='commander' && count===1 && name.toLowerCase().includes('commander')) deck.commander={id:id,name:name,type_line:'',image_uris:null};
      else{
        deck.map[id]={card:{id:id,name:name,type_line:'',image_uris:null},count:count};
        deck.order.push(id);
      }
    }
  });
  renderDeck();
});

document.getElementById('exportDeckBtn').addEventListener('click',updateExportArea);

document.getElementById('searchBtn').addEventListener('click',doSearch);

document.getElementById('formatSelect').addEventListener('change',(e)=>{
  activeFormat=e.target.value; updateDeckTitle(); renderDeck(); updateCommanderSlotVisibility();
});

document.getElementById('toggleFilters').addEventListener('click',()=>{
  const panel=document.getElementById('filterPanel');
  panel.style.display=panel.style.display==='none'?'block':'none';
});

document.getElementById('applyFilters').addEventListener('click',doSearch);
document.getElementById('clearFilters').addEventListener('click',()=>{
  document.getElementById('typeSelect').value='';
  document.getElementById('supertypeSelect').value='';
  document.getElementById('subtypeInput').value='';
  Array.from(document.getElementById('colorSelect').options).forEach(o=>o.selected=false);
  document.getElementById('formatLegalitySelect').value='';
  doSearch();
});

// Commander buttons
document.getElementById('setCommanderBtn').addEventListener('click',()=>{
  if(!lastSearchData || lastSearchData.length===0){ alert('Search a card first'); return; }
  const card=lastSearchData[0]; // pick first search result
  const deck=getCurrentDeck();
  deck.commander={id:card.id,name:card.name,type_line:card.type_line,image_uris:card.image_uris||null};
  document.getElementById('commanderInfo').textContent=card.name;
  renderDeck();
});
document.getElementById('removeCommanderBtn').addEventListener('click',()=>{
  const deck=getCurrentDeck(); deck.commander=null;
  document.getElementById('commanderInfo').textContent='No commander selected';
  renderDeck();
});

// Initial
updateDeckTitle();
updateCommanderSlotVisibility();
renderDeck();
</script>
</body>
</html>
